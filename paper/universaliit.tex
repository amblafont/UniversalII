

% We are also careful to explain where UIP or functional extensionality that is
% available in extensional type theory are used.

We construct the theory of IIT signatures in the following steps:
\begin{enumerate}
\item We view the theory of signatures as a type theory, and we define
  its untyped syntax as mutual inductive types together with typing
  judgments given by inductive relations on the untyped syntax. Then
  the syntax $\I : \SignAlg$ is constructed using those untyped terms
  for which the typing relation holds.
\item We construct $\ll\blank\rr:\SignMor\,\I\,M$ for arbitrary
  $M : \SignAlg$, by:
  \begin{enumerate}
  \item defining a relation $\blank \sim \blank$ between the well-typed syntax
    and a given signature algebra. The idea is that given a syntactic context $\GG$ and a
    semantic context $\model{\GG}$ of the signature algebra $M$, we have
    $\GG \sim \model{\GG}$ if and only if $\ll\GG\rr
    = \model{\GG}$, and similarly for types, terms, and substitutions;
    % semantic context $\model{\GG}$ of
    % the model $M$ if and only if $\GG$ relates to $\rec\,{\GG}$;
    % enjoyed by the initial morphism from the
    % syntax to a given model;
  \item showing that this relation is functional and thus obtaining a morphism.
    \end{enumerate}
  \item Proving the uniqueness of this morphism by showing that any morphism
    $f:\SignMor\,\I\,M$ satisfies the relation. For example, for any syntactic context
    $\GG$ we have $\GG\sim f\,\GG$.
      % TODO donner composantes sur les contextes
\end{enumerate}
The next sections detail each of these steps.

\subsection{Syntax}

The goal is to define the syntactic signature algebra where contexts
are pairs of a precontext together with a well-formedness proof, and
similarly for types, terms and substitutions.

Crucially, we do not have conversion relations for typed syntax, nor
do we need to use quotients when constructing the syntax. This is
possible because there are no $\beta$-rules in the theory of
signatures. Hence, we consider only normal terms in the untyped
syntax, and define weakening and substitution by recursion.  Avoiding
quotients is important for two reasons. First, it greatly simplifies
formalisation. Second, we aim to reduce the theory of signatures only
to inductive types, thus making \Cref{thm:WToToS} stronger.

Now we present the definition of the untyped syntax and the
associated typing judgments.

\subsubsection{Untyped Syntax and its Properties}

\begin{definition}[Untyped syntax]
The untyped syntax is defined as the following inductive datatype.
\begin{alignat*}{5}
  & \rlap{(1) Substitution calculus} \\
  & \Conu && : \Set \\
  & \Tyu  && : \Set \\
  & \Subu  && : \Set \\
  % & \Subpre  && : \Set \\
  & \Tmu  && : \Set \\
  & \emptyu && : \Conu \\
    & \epsilonu && : \Subu \\
  & \blank\extu\blank && : \Conu\ra\Tyu\ra\Conu \\
  & \blank\consu\blank && : \Subu\ra\Tmu\ra\Subu \\
  & \varu  && : \N \ra \Tmu \\
  & \rlap{(2) Universe} \\
  & \Uu && : \Tyu \\
  & \Elu && : \Tmu\ra\Tyu \\
  & \rlap{(3) Inductive parameters} \\
  & \Piu && : \Tmu\ra\Tyu\ra\Tyu \\
  & \blank\appu\blank && : \Tmu\ra\Tmu\ra \Tmu \\
  & \rlap{(4) External parameters} \\
  & \Pimu && : (T:\Set)\ra(T\ra\Tyu)\ra\Tyu \\
  & \Piiu && : (T:\Set)\ra(T\ra\Tmu)\ra\Tmu \\
  & \blank\appmu \blank && : \Tmu\ra(\alpha:T) \ra\Tmu\\
  & \rlap{(5) Default value} \\
  & \erru && : \Tmu
\end{alignat*}
\end{definition}
Variables are modeled as de Bruijn indices, i.e.\ as natural numbers
pointing to a position in the context. We use the additional default
constructor $\erru:\Tmu$ in case of error (ill-scoped
substitution). The typing judgments will not mention $\erru$.  The
main interest of $\erru$ is that it behaves like a closed term (which
the theory of signatures lacks), in the sense that it is invariant
under substitution. This makes expected equalities about substitution
true even in the ill-typed case, thus reducing the number of
hypotheses for the corresponding lemmas (see
\Cref{lem:exch-laws}).

% The type of (untyped) substitution is then defined as $\Subu = \List\,\Tmu$.
% Note that $\Conu$ could also be defined as a list of types in a similar fashion.

We will define substitutions $\blank[\blank]$ of types and terms
recursively.

Note that $(\Piu \,A\,B)[\sigma]$ should be defined as
$\Piu \,(A[\sigma])\,(B[\wkO\,\sigma \,\consu\, \varu\,\mathsf{0}])$,
and thus we need to define $\wkO$, the weakening of substitutions.
The basic idea is to increment the de Bruijn indices of all the
variables.  Actually, this is not so simple because of the $\Piu$
type: we want to define $\wkO\,(\Piu\,A\,B)$ as the $\Pi$ type of the
weakening of $A$ and $B$, but here, $B$ must be weakened with respect
to the second last variable of the context, rather than the last one.
For this reason, we need to generalise the weakening as occuring
anywhere in the context.

\begin{definition}[Untyped weakening]
  We define untyped weaking recursively on terms by the following
  functions.
  \begin{alignat*}{5}
    & \wk_n && :  \Tyu\ra\Tyu \\
    & \wk_n && :  \Tmu\ra\Tmu \\
    % & \wk && : \N \ra \N\ra\N \\
    & \wkO && : \Subu\ra \Subu
  \end{alignat*}
  The natural number $n$ specifies at which position of the context the
  weakening occurs.
  Here, $\wkO$ weakens with respect to the last variable.
\end{definition}

Later, in \Cref{lem:weaken-typing}, we show that weakening preserves
typing.  Stating a typing rule for this operation requires weakening
at the middle of a context. This is why we define pairs of untyped
contexts, which should be thought of as a splitting of a context at
some position. We call the second context a telescope over the first
one.
% (which appears in the typing rule of a weakening occuring in the middle of a context),
% and the length $\length{\GG}$ of a
% context $\GG$:
\begin{definition}[Untyped telescopes]
  An untyped telescope is given simply by a $\Conu$.
\end{definition}
\begin{definition}[Merging of a context and a telescope]
\begin{alignat*}{5}
  & \blank \merge \blank && :  \Conu\ra\Conu\ra\Conu \\
  & \GG \merge \cdot && :=  \GG \\
  & \GG \merge (\GD \extu A) && :=  (\GG \merge \GD)\extu A
\end{alignat*}
\end{definition}
\begin{definition}[Weakening for telescopes]
Weakening for telescopes is defined pointwise. $\length{\GG}$ denotes
the length of the context $\GG$.
\begin{alignat*}{5}
  & \wkO && : \Conu\ra \Conu
  \\
  & \wkO\,\emptyu && := \emptyu
  \\
  & \wkO\,(\GD\,\extu A) && := \wkO\,\GD\,\extu \wk_{\length{\GD}}\,A
  \end{alignat*}
\end{definition}
This will be used to give typing rules for telescopes
in \Cref{def:typing_judgments}.

\begin{definition}[Untyped unary substitution]
  We define single substitution by recursion on the presyntax:
  % & \rlap{(1) Substitution calculus} \\[0.5em]
\begin{alignat*}{5}
  & \blank[\blank := \blank] && : \Tyu\ra\N\ra\Tmu\ra\Tyu \\
  & \blank[\blank := \blank] && : \Tmu\ra\N\ra\Tmu\ra\Tmu
  % \\
  % & \blank[\blank := \blank] && : \N\ra\N\ra\Tmu\ra\Tmu
\end{alignat*}
\end{definition}
  This is enough to state the typing judgments: indeed, the typing rule for application
  involves only a unary substitution.

  However, to construct the syntax as a signature algebra, we need to define
  parallel substitutions:
\begin{definition}[Untyped substitution calculus]
  \begin{alignat*}{5}
  & \blank[\blank] && : \Tyu\ra\Subu\ra\Tyu \\
  & \blank[\blank] && : \Tmu\ra\Subu\ra\Tmu \\
  & \blank \circ \blank && : \Subu\ra\Subu\ra \Subu
  \end{alignat*}
These can be defined either by iterating unary substitutions, or by recursion
on untyped syntax: the two ways yield provably equal definitions. In the
following, we assume that they are defined by recursion. We also make use of the
following definition:
  \begin{alignat*}{5}
  % liftV (S (n + p)) (liftV n q) ≡ liftV n (liftV (n + p) q)
  & \keep && : \Subu \ra \Subu \\
   &&& := \lambda \sigma. (\wkO\,\sigma \,\consu\, \varu\, \mathsf{0})
  \end{alignat*}
  The idea is that if $\sigma$ is a substitution from $\GG$ to
  $\GD$, then $\keep\,\sigma$ is a substitution between contexts $\GG\ext A[\sigma]$
  and $\GD\ext A$ for any type $A$ where the last term is just a de Bruijn index $0$. This occurs when defining
  $(\Piu\,A\,B)[\sigma]$ as $\Piu\,(A[\sigma])\,(B[\keep \,\sigma])$.

  We define the identity substitution on a context $\GG$ as
  follows, where $\keep^{\length{\GG}}$ is $\keep$ iterated
  $\length{\GG}$ times:
\begin{alignat*}{5}
  & \idu && : \Conu \ra \Subu \\
  & && := \lambda \GG.\keep^{\length{\GG}} \epsilonu
  \end{alignat*}
\end{definition}

\begin{lemma}[Exchange laws for weakening and substitution]\label{lem:exch-laws}
  Below, $Z$ denotes either a term or a type and $\keep^n$ denotes
  the $n$ times iteration of $\keep$.
\begin{alignat*}{5}
  % liftV (S (n + p)) (liftV n q) ≡ liftV n (liftV (n + p) q)
  & \wk\mhyphen\wk && : \wk_{n+p+1} (\wk_n\,Z) = \wk_n(\wk_{n+p}\,Z)\\
  % n-subZ-wkZ : ∀ n A z → (lifZZ n A) [ n ↦ z ]Z  ≡ A
  & \wk_n[n] && : (\wk_{n}\,Z)[ n := z] = Z \\
  % lifZ-l-subV : ∀ n p u x → lifZZ (n + p) (x [ n ↦ u ]V) ≡ (lifZV (S (n + p)) x) [ n ↦ (lifZZ p u) ]V
  & \wk_+[] && : (\wk_{n+p+1}\,Z)[ n := \wk_p\,u] = \wk_{n+p}\,(Z[n := u]) \\
  % l-subV-lifZV : ∀ Δ u n x → (lifZV n x) [ (S (n + Δ)) ↦ u ]V  ≡ lifZZ n (x [ (n + Δ) ↦ u ]V)
  & \wk[+] && : (\wk_{n}\,Z)[ n+p+1 :=  u] = \wk_{n}\,(Z[n+p := u]) \\
  % l-subV-l-subV : ∀ n p z u x →  (x [ n ↦ u ]V) [ (n + p) ↦ z ]Z  ≡ (x [ (S (n + p)) ↦ z ]V) [ n ↦ (u [ p ↦ z ]Z) ]Z
  & [][+] && : Z[n :=u][n+p:=z] = Z[n+p+1:=z][n:= (u[p:=z])] \\
  % liftV (S (n + p)) (liftV n q) ≡ liftV n (liftV (n + p) q)
  % liftV=wkS
  & [\keep^n\mhyphen \wkO] && : Z[\keep^n\,(\wkO\,\sigma)] = \wk_n (Z[\keep^n\,\sigma])
  \\
  % lifZₛV : ∀ n xp σp Zp → (lifZV n xp [ iZer n keep (Zp ∷ σp) ]V) ≡ (xp [ iZer n keep σp ]V)
  & \wk_n[\keep^n\mhyphen\cons]  & &
  :
  (\wk_n\,Z) [\keep^n\, (\sigma \consu u)] = Z [ \keep^n \sigma]
  \\
  % l-sub[]V : ∀ n x z σ
    % ((x [ n := z ]V) [ iZer n keep σ ]Z) = (x [ iZer (S n) keep σ ]V) [ n := (z [ σ ]Z) ]Z
   & [:=][\keep] && : Z [ n:= u][\keep^n\,\sigma] =  Z[\keep^{n+1}\,\sigma][n := u[\sigma]]
  \end{alignat*}
\end{lemma}
\begin{proof}
By induction on the untyped syntax.
\end{proof}

\begin{corollary}
As particular cases for $n=0$, we get
\begin{alignat*}{5}
  & {}{\circ}{}\wkO & & : \sigma \circ (\wkO \tau) = \wkO (\sigma \circ \tau) \\
  & \wkO{}{\circ}{}, && : \wkO\,\sigma \circ (\tau \consu t) = \sigma \circ \tau \\
  & [\wkO] && : t[\wkO\,\sigma] = \wk_0 (t[\sigma]) \\
  & \wk_0[\cons] && : (\wk_0\,Z)[\sigma \consu u] = Z[\sigma] \\
  & [0:=][] && : Z [ 0:= u][\sigma] =  Z[\keep\,\sigma][0 := u[\sigma]]
\end{alignat*}
\end{corollary}

\begin{lemma}[Composition functor law and associativity]
\begin{alignat*}{5}
  & [][] && : Z[\sigma][\tau] = Z[\sigma\circ\tau]
  \\
  & \ass && : (\sigma\circ \delta)\circ\tau = \sigma\circ (\delta\circ\tau)
\end{alignat*}
\end{lemma}

We defer laws for identity substitutions after the definition of the typing
judgments, as the proofs require that some inputs are well-typed.

  % The two ways yield provably equal definitions, but
  % The advantage of the second
  % one in a type theory with UIP and function extensionality is that we get
  % definitional equalities such as $(t\,\appu\,u)[\sigma]=\app\,t[\sigma]\,u[\sigma]$.

  % \\
  % & \blank[\blank := \blank] && : \N\ra\N\ra\Tmu\ra\Tmu

\subsubsection{Typing Relations and Their Properties}

\begin{definition}[Typing relations]\label{def:typing_judgments}
  The typing relations are defined as the following inductive type indexed over the
  untyped syntax:
\begin{alignat*}{5}
  & \rlap{(1) Substitution calculus} \\[0.5em]
  & \blank \vdash && : \Conu\ra \Set \\
  & \blank \vdash \blank  && : \Conu\ra \Tyu\ra\Set \\
  & \blank \vdash \blank \invar \blank  && : \Conu\ra \N \ra \Tyu\ra \Set \\
  & \blank \vdash \blank \in \blank  && : \Conu\ra \Tmu\ra \Tyu\ra \Set \\
  & \blank \vdash \blank \Rightarrow \blank  && : \Conu\ra \Subu \ra \Conu\ra \Set \\
  % & \Subpre  && : \Set \\
  & \emptyw && : \emptyu \vdash \\
  & \epsilonw && : \GG\vdash \epsilonu \Rightarrow \emptyu \\
  & \blank\extw\blank && : ( \GG\vdash )  \ra  (\GG\vdash A)  \ra
  \GG\extu A \vdash \\
  & \consw && :
    (\GD \vdash) \ra
    (\GG\vdash \sigma \Rightarrow\GD)\ra
    ( \GD \vdash A) \ra
    ( \GG \vdash t \in A[\sigma]) \ra
    \GG \vdash \sigma\consu t \Rightarrow \GD\extu A
   \\
  & \varw  && : (\GG \vdash n \invar A) \ra \GG \vdash \varu n \in A \\
  & \vzw  && : (\GG\vdash)\ra(\GG\vdash A)\ra\GG \extu  A \vdash \mathsf{0} \invar \wku \, A \\
  & \vsw  && : (\GG\vdash)\ra(\GG\vdash A)\ra(\GG \vdash n \invar A) \ra (\GG \vdash B) \ra \GG \extu  B
  \vdash \mathsf{S}\,n \invar \wku \, A \\
  & \rlap{(2) Universe} \\[0.5em]
  & \Uw && : (\GG \vdash)\ra \GG \vdash \Uu \\
  & \Elw && : (\GG \vdash)\ra (\GG \vdash a \in \Uu)\ra\GG \vdash \Elu\,a \\
  & \rlap{(3) Inductive parameters} \\[0.5em]
\  & \Piw && :
    (\GG \vdash)\ra (\GG \vdash a \in \Uu)\ra(\GG \extu
  \Elu\,a \vdash B)\ra\GG \vdash \Piu \, a \, B \\
  & \appw && :
    (\GG \vdash)\ra (\GG \vdash a \in \Uu)\ra(\GG \extu
    \Elu\,a \vdash B)
    \\
    & &&
    \ra(\GG \vdash t \in \Piu \, a \, B )
    \ra
    (\GG \vdash u \in \Elu\,a)
    \ra
    \GG \vdash t \appu u \in  B [0 := u] \\
  & \rlap{(4) External parameters} \\[0.5em]
  & \Pimw && :
    (T:\Set)\ra(A : T\ra \Tyu)\ra(\GG \vdash)\ra
    ((t : T)\ra\GG\vdash A\,t) \ra
    \GG \vdash \Pimu \,T\,A
    \\
    & \appmw  && :
    (T:\Set)\ra(A : T\ra \Tyu)\ra(\GG \vdash)\ra
    ((t : T)\ra\GG\vdash A\,t)
    \\
    & &&
    \ra(\GG \vdash t \in \Pimu \,T\,A)
    \ra (u : T) \ra \GG \vdash t\,\appmu\,u \in A\,u
  \end{alignat*}
\end{definition}
There is possibility of redundancy in the arguments of the
constructors. Here, we are ``{paranoid}'' (nomenclature from
\cite{paranoid}), so that we get more inductive hypotheses when
performing recursion.

% The substitution part could be moved after the mutual definition of terms, types,
% and contexts.

\begin{lemma}[Weakening preserves typing]\label{lem:weaken-typing}
% wkTelw : ∀ {Γp}{Ap}(Aw : Γp ⊢ Ap)Δp (Δw : (Γp ^^ Δp) ⊢) → ((Γp ▶p Ap) ^^ wkTel Δp) ⊢
% liftTw : ∀ {Γp}{Ap}(Aw : Γp ⊢ Ap)Δp{Bp}(Bw : (Γp ^^ Δp) ⊢ Bp) → ((Γp ▶p Ap) ^^ wkTel Δp) ⊢ (liftT ∣ Δp ∣ Bp)
\begin{alignat*}{5}
  & \wf{\wkO} && : (\GG \vdash A)\ra(\GG \merge \GD\vdash) \ra
  \GG \extu A \merge \wkO\, \GD \vdash \\
  % liftV (S (n + p)) (liftV n q) ≡ liftV n (liftV (n + p) q)
  & \wf{\wk} && : (\GG \vdash A)\ra(\GG \merge \GD\vdash B) \ra
  \GG \extu A \merge \wkO\,\GD \vdash \wk_{\length{\GD}}\, B  \\
  & \wf{\wk} && : (\GG \vdash A)\ra(\GG \merge \GD\vdash t\in B) \ra
  \GG \extu A \merge \wkO\,\GD \vdash \wk_{\length{\GD}}\, t \in \wk_{\length{\GD}}\,B  \\
  & \wf{\wkO} && : (\GG \vdash A)\ra(\GG \vdash \sigma
  \Rightarrow \GD) \ra
  \GG \extu A \vdash \wkO\, \sigma \Rightarrow \GD
  \end{alignat*}
\end{lemma}
\begin{proof}
By mutual induction on the typing relations.
\end{proof}

We show that judgments are stable under substitution.
\begin{lemma}[Substitution preserves typing]
\begin{alignat*}{5}
  % Tyw[] : ∀ {Γp}{Ap}(Aw : Γp ⊢ Ap) {Δp}(Δw : Δp ⊢){σp}(σw :  Δp ⊢ σp ⇒ Γp) → Δp ⊢ (Ap [ σp ]T)
  & \wf{[]} && : (\GG \vdash)\ra(\GD \vdash A)\ra
  (\GG \vdash \sigma \Rightarrow \GD) \ra
  \GG \vdash A [ \sigma ]
  \\
  & \wf{[]} && : (\GG \vdash)\ra(\GD \vdash t \in A)\ra
  (\GG \vdash \sigma \Rightarrow \GD) \ra
  \GG \vdash t [\sigma] \in A [ \sigma ]
  \\
  & \wf{[]} && : (\GD \vdash x \invar A)\ra
  (\GG \vdash \sigma \Rightarrow \GD) \ra
  \GG \vdash x [\sigma] \in A [ \sigma ]
  % ∘w : ∀ {Γ} {Δ σ} (σw :  Δ ⊢ σ ⇒ Γ)
  %  {Y}(Yw : Y ⊢) {δ} (δw :  Y ⊢ δ ⇒ Δ) →
  %  Y ⊢  (σ ∘p δ) ⇒ Γ
  \\
  & \wf{{\circ}} && :
  (\GG \vdash) \ra
  (\GG \vdash \sigma \Rightarrow \GD) \ra
  (\GD \vdash \tau \Rightarrow E) \ra
  \GG \vdash \tau \circ \sigma \Rightarrow E
  % keepw : ∀ {Γp}(Γw : Γp ⊢){Δp}(Δw : Δp ⊢){σp}(σw :  Γp ⊢ σp ⇒ Δp) {Ap}(Aw : Δp ⊢ Ap ∈ Up ) → (Γp ▶p (Elp Ap [ σp ]T )) ⊢ (keep σp) ⇒ (Δp ▶p Elp Ap)
  % & \wf{keep-\El} && : (\GG \vdash)\ra(\GD \vdash A)\ra
  % (\GG \vdash \sigma \Rightarrow \GD) \ra
  % \GG \vdash A [ \sigma ]
  % \\
\end{alignat*}
\end{lemma}
\begin{proof}
By mutual induction on the typing relations.
\end{proof}

We show the category and functor laws involving identity substitution
for well-formed types, terms and substitutions.
\begin{lemma}[Identity laws]\label{lem:identity}
\begin{alignat*}{5}
  % [idp]V : ∀ {Γ}{A}{x}(xw : Γ ⊢ x ∈v A) → (x [ idp ∣ Γ ∣ ]V) ≡ V x
  & [\idu] && : (\GG \vdash A)\ra A [ \idu\,\GG] = A \\
  & [\idu] && : (\GG \vdash x \invar A)\ra x [ \idu\,\GG] = V x \\
  & [\idu] && : (\GG \vdash t \in A)\ra t [ \idu\,\GG] = t \\
  & \idru && : (\GG \vdash \sigma \Rightarrow\GD)\ra \sigma \circ \idu\,\GG = \sigma \\
  & \idlu && : (\GG \vdash \sigma \Rightarrow\GD)\ra \idu\,\GD\circ \sigma = \sigma
  \end{alignat*}
\end{lemma}
Finally, we show that the identity substitution itself is well-typed:
\begin{lemma}[Typing for the identity substitution]
  \begin{alignat*}{5}
  & \idw && : (\GG \vdash)\ra \GG \vdash \idu\,\GG \Rightarrow \GG
  \end{alignat*}
\end{lemma}

\begin{definition}[Proposition]
  A type is a proposition, or proof-irrelevant, if it has at most one inhabitant.
  \[
    \isaprop\,T := (a : T) \ra (a' : T) \ra a = a'
  \]
\end{definition}

\begin{lemma}[Proof irrelevance of typing relations]\label{lem:uniq-typing-types}
\begin{alignat*}{5}
 & \isp{\Conw} && : \isaprop\, (\GG\vdash) \\
 & \isp{\Tyw} && : \isaprop\, (\GG\vdash A) \\
 & \isp{\wf\Var} && : \isaprop\, (\GG\vdash x \invar A) \\
 & \isp{\Tmw} && : \isaprop\, (\GG\vdash t \in A) \\
 & \isp{\wf\Sub} && : \isaprop\, (\GG\vdash \sigma \Rightarrow \GD)
\end{alignat*}
\end{lemma}

\begin{lemma}[Unicity of typing]
\begin{alignat*}{5}
  &
  \Tmw{=}\Ty & &:
  (\GG \vdash t \in A) \ra
  (\GG \vdash t \in B) \ra A = B
  \\
  &
  \wf\Var{=}\Ty & &:
  (\GG \vdash x \invar A) \ra
  (\GG \vdash x \invar B) \ra A = B
\end{alignat*}
\end{lemma}
Let us consider for instance the application constructor $\appw$: for a codomain
type $B$ it yields an overall type $C=B[\mathsf{0} := u]$ for an application. Even
if $C$ is known a priori, there may be another $B$ for which $B[\mathsf{0} := u] = C$,
possibly leading to many proofs that $t\appu u$ has type $C$. Unicity of typing
solves this issue, as $B$ is then uniquely determined by the type $\Piu\,A\,B$
of $t$.

%% Actually, the application and successor cases require to show uniqueness of
%% types in a given context, before.
%% Let us consider for instance the application constructor $\appw$: it provides a
%% type $B$ such that the final type is $C=B[0 := u]$. Even if $C$ is known a
%% priori, there may be another $B$ for which $B[0 := u] = C$, possibly leading to
%% many proofs that $t\appu u$ has type $C$. Uniqueness of types
%% solves this issue, as $B$ is then uniquely determined by the type $\Piu\,A\,B$ of $t$.


% \subsubsection{UIP and functional extensionality}
 % , which is not applyable without
 % functional extensionality.

\subsubsection{The Syntax as a Signature Algebra}

\begin{definition}[Syntax for the theory of signatures]\label{def:syntax}
  We define the syntax as an element of $\SignAlg$ by pairs of untyped
  syntax and typing relations:
% % \subsection{QIIT model}
% Then, we show that they are stable by weakening and substitution.
% Packing the untyped syntax with well-formed typed judgments yields
% a model $S$ of the QIIT. Let us give the most important components:
\begin{alignat*}{5}
 & \syn\Con && := \sum_\GG \GG\vdash
 \\
 & \syn\Ty \,(\GG,\wf\GG)&& := \sum_A \GG\vdash A
 \\
 & \syn\Tm \,(\GG,\wf\GG)(A,\wf A)&& := \sum_t \GG\vdash t \in A
 \\
 & \syn\Sub \,(\GG,\wf\GG)(\GD,\wf \GD)&& := \sum_\sigma \GG\vdash \sigma \Rightarrow \GD
\end{alignat*}
The other fields are given straightforwardly.  Regarding the equations, it is
enough to prove them only for the untyped syntactic part: as we argued in
\Cref{lem:uniq-typing-types}, the proofs of typing judgments are
automatically equal.
\end{definition}

\begin{remark}
  Up until \Cref{def:syntax}, UIP is not used. Function extensionality
  on the other hand is necessary because the untyped metatheoretic
  $\Pi$ takes a metatheoretic function as an argument. An example
  induction step that uses function extensionality is in
  \Cref{lem:identity}, in particular in the case
  $(\Pim\,T\, A)[\id]=\Pim\,T\,A$. Indeed, the left hand side of this
  equation is equal to $\Pim\,T\,(\lambda t.(A\,t)[\id])$ by
  definition, whereas the induction hypothesis states that
  $(t:T)\ra (A\,t)[\id]=A\,t$.
\end{remark}

\subsection{Relating the Syntax to a Signature Algebra}
\label{sec:streicher}

It remains to show that the constructed syntax $\I$ is the initial
signature algebra. To achieve this, we first define a relation between
the syntax and any signature algebra, then show that the relation is
functional, which lets us extract a signature morphism from the relation.

This approach is an alternative presentation of Streicher's method for
interpreting preterms in an arbitrary model of type theory
\cite{streichersemantics}. Streicher first defines a family of partial
maps from the presyntax to a model, then shows that the maps are total
on well-formed input. We have found that our approach is significantly
easier to formalise. To see why, note that the right notion of partial
map in type theory, which does not presume decidable definedness, is
fairly heavyweight:
\[
  \mathsf{PartialMap}\,A\,B := A\ra \big((P : \Set)\times\isaprop\,P\times (P \ra B)\big)
\]
In the above definition, we notice an opportunity for converting a fibered
definition of a type family into an indexed one; if we drop the propositionality
for $P$ for the time being, we may equivalently return a family indexed over
$B$, which is exactly just a relation $A\ra B\ra\Set$. Then, in our approach, we
recover uniqueness of $P$ through the functionality requirement on the $A\ra
B\ra\Set$ relation, and totality by already assuming well-formedness of $A$. In
type theory, using indexed families instead of display maps is a common
convenience, since the former are natively supported, while the
latter require carrying around auxiliary propositional equalities.

\subsubsection{The Functional Relation}

Given an $M : \SignAlg$, we define the functional relation satisfied by
the  $\ll\blank\rr : \SignMor\,\I\, M$ by recursion on the typing judgments.
% As these judgments are propositions, we will sometimes
If $\GG$ is a context in $\I$ and $\model{\GG}$ is a semantic context
(i.e.\ a context in the signature algebra $M$), we want to define a type
$\GG\sim \model{\GG}$ equivalent to $\ll\GG\rr =\model{\GG}$. Of
course, at this stage, $\ll\blank\rr$ is not available yet since the point of
defining this relation is to construct $\ll\blank\rr$ in the end.

For a type $A$ in a context $\GG$, we want to define a relation
$A\sim \model{A}$ that is equivalent to $\ll A\rr=\model{A}$.
% where $\model{A}$ is a
% semantic type in a semantic context $\model{\GG}$.
For this equality to make sense, the semantic type $\model{A}$ must live
in the semantic context $\ll\GG\rr$. But again, $\ll\blank\rr$ is not
yet available at this stage. Exploiting the expected equivalence between
$\GG\sim\model\GG$ and $\ll\GG\rr=\model\GG$, we may consider defining $A\sim\model{A}$ under the
hypotheses that $\model{A}$ lies in a semantics context $\model\GG$ which is
related to $\GG$. Then, the type of the relation for types is
\[
  (\GG : \syn\Con)\ra (A : \syn\Ty\,\GG) \ra
  (\model\GG : \model\Con)
  \ra
  (\GG \sim \model\GG)
  \ra
  (\model{A}:\model\Ty\,\model\GG)
  \ra
  \Set
\]
Note that the relation on contexts
must be defined mutually with the relation on types (see for example the case of
context extension), but here, the relation on contexts appears as the type of an
argument of the relation on types.
% We leave this possibility aside,
We want to avoid using such recursive-recursive
definitions as they are not allowed by the elimination principles of indexed inductive types, so we instead just remove the hypothesis
$\GG\sim\model\GG$ from the list of arguments.  We proceed similarly for
terms and substitutions. Actually, this removal is not without harm. For
example, consider relating the empty substitution
$\GG\vdash \epsilonu \Rightarrow \emptyu $ to a semantic substitution
$\model\sigma : \model\Sub\,\model\GG\,\model\GD$. We would like to assert
that $\model\sigma$ equals the empty semantic substitution $\model\epsilon$, but
this is not possible because typechecking requires that $\model\GD$ is the
empty semantic context. This is precisely what was ensured by the hypothesis
$\syn\cdot \sim \model\GD$ we removed.  Our way out here is to state that $\model\sigma$
is related to the empty substitution if the target semantic context $\model\GD$
is empty, and, acknowledging this equality, if $\model\sigma$ is the empty
substitution.
% The idea is that we will first prove that there is atmost one semantic type
% which relates to the syntactic one, and then later we will provide such a
% semantic type under the hypothesis that the contexts are related.

Let us mention another possible solution for avoiding recursion-recursion:
defining $A\sim\model{A}$ so that it is equivalent to $(e:\ll\GG\rr
= \model{\GG})\times (\ll A\rr = _{e\#}\model{A})$.
% whereas the right hand side is of type $\model\Ty\model{\GG}$.
% For a substitution $\sigma$ between contexts $\GG$ and $\GD$,
% a first idea consists in defining a relation $\sigma \sim_{\blank} \model{\sigma} : \GG
% \sim \model\GG \to \Set $ where $\model{A}$ is a semantic type in the
% semantic context $\model{\GG}$. We define the relation on types under the hypothesis
% that the contexts are already related.
% it is natural to define the relation with a semantic type $\model{A}$ in a
% semantic context $\model{\GG}$ such that it is equivalent to  $(\rec\,\GG = \model{\GG})\times (\rec\,A = \model{A})$ (note that the first equality is
% required for the second one to be well-typed).
% The discussion is similar for terms.
% Then, the ultimate goal is to prove that
% $\sum_{\model{\GG}}\GG\sim\model{\GG}$ and
% $\sum_{\model{\GG}}({\model{A}:\model{\Ty}\,\model{\GG}})\times(A\sim\model{A})$
% are contractible, i.e., have a unique inhabitant.
%The first step consists in showing that these types are propositions.
In comparison, our approach
% Actually, we take a different approach for the relation on types
% (and terms) which
yields a more concise definition of the relation.
For example, in the case of the universe, this would lead
to the definition
  $  \Uw\,\wf{\GG} \sim \model{A} := (\wf{\GG}\sim\model{\GG}) \times (\model{A} = \model{\U})$,
  instead of
  our definition
  $  \Uw\,\wf{\GG} \sim \model{A} := (\model{A} = \model{\U})$.
% Recall that our adapted goal, for types, is to prove that
% $\sum_{\model{A}}A\sim\model{A}$ is a proposition, and
% is inhabited if $\GG \sim \model{\GG}$ is.
%  This means that in the definition of the relation, we assume
% that contexts are already related, so that we don't need to enforce them to be,
% as it is the case in the original approach.
% We give the two versions of the universe
% case below, to explain the differences.


% Many of the terms below are well-typed because the target model satisfies some
% equalities that are reflected as definitional equalities.
% In the formalization, we even postulate rewrite rules for some of the equations that the
% model $M$ should satisfy (otherwise, we are faced with too many hellish transports).
% This is, in some sense, another place where UIP is needed, as it is known that
% extensional type theory can be translated in intensional type theory using UIP
% and functional extensionality. This requirement can be qualified: we
% could say that we only claim to eliminate to models that definitionally
% satisfies the equalities that we enforce, although we haven't checked that this is enough to
% construct any IIT from the universal one (and anyway, UIP and functional
% extensionality are needed to construct any IIT from the universal one).

\begin{definition}[Relation $\blank\sim\blank$]
We define the relation by recursion on the typing judgments.
In the following, we abbreviate $\relT{\wf{A}}{\model\GG}{\model{A}}$ by
$\wf{A}\sim\model{A}$ when $\model{\GG}$ can be inferred, and similarly for
terms and substitutions.
\begin{alignat*}{5}
  & \rlap{(1) Substitution calculus} \\
  & \blank \sim{ \blank} && :  \GG \vdash \, \ra \model{\Con} \ra \Set \\
  & \relT{\blank}{\model{\GG}}{\blank} && :  \GG \vdash A \, \ra \model{\Ty}\,\model{\GG} \ra \Set \\
  & \relt{\blank}{\model{\GG}}{\model{A}}{\blank} && :  \GG \vdash t \in A \, \ra \model{\Tm}\,\model{\GG}\,\model{A} \ra \Set \\
  & \relV{\blank}{\model{\GG}}{\model{A}}{\blank}&& :  \GG \vdash x \invar A \, \ra \model{\Tm}\,\model{\GG}\,\model{A} \ra \Set \\
  & \relS{\blank}{\model{\GG}}{\model{\GD}}{ \blank} && :  \GG \vdash \sigma \Rightarrow \GD \, \ra \model{\Sub}\,\model{\GG}\,\model{\GD} \ra \Set \\
  \\
  & \emptyw\sim \model{\GG} && := \model{\GG}=\model{\boldsymbol{\cdot}} \\
  & \relS{\epsilonw}{\model{\GG}}{\model{E}}{\model{\delta}}
  % (  \vdash \model{\delta}\Rightarrow \model{E})
  &&
 := (e_E : \model{E} = \model{\boldsymbol{\cdot}})\times (\model{\delta} = _{e_E \#}
 \model{\epsilon})
  \\
  & (\wf{\GG}\extw \wf{A})\sim \model{\GD} &&
   :=
    \sum_{\model{\GG}} (\wf{\GG}\sim\model{\GG}) \times
    \sum_{\model{A}} (\wf{A}\sim\model{A}) \times
    \\
    & && \qquad
    (\model{\GD} = \model{\GG} \model{\ext} \model{A})
    \\
    &
    \relS{(\consw\wf{\GD}\wf{\sigma}\wf{A}\wf{t})}{\model{\GG}}{\model{E}}{\model{\delta}}
    % (\consw \wf{\GD}\wf{\sigma}\wf{A}\wf{t})\sim
    % \\
    % & \qquad
    % ( \model{\GG} \vdash \model{\delta}\Rightarrow \model{E})
    &&
   :=
    \sum_{\model{\GD}} (\wf{\GD}\sim\model{\GD}) \times
    \sum_{\model{\sigma}} (\wf{\sigma}\sim\model{\sigma}) \times
    \\
    & && \qquad
    \sum_{\model{A}} (\wf{A}\sim\model{A}) \times
    \sum_{\model{t}} (\wf{t}\sim\model{t}) \times
    \\
    & && \qquad
    (e_E : \model{E} = \model{\GD} \model{\ext} \model{A}) \times
    \\
    & && \qquad
    (\delta = _{e_E \#} \model\sigma \model{\cons} \model{t} )
    \\
  & \varw\,\wf{x} \sim \model{t}
   && := \wf{x}\sim \model{t} \\
   & \relV{\vzw\wf{\GG}\wf{A}}{\model{\GD}}{\model{B}}{\model{t}}
  %  \vzw\wf{\GG}\wf{A}
  % \sim \\
  % & \qquad (\model{\GD}\vdash \model{t}\in \model{B} )
   && :=
    \sum_{\model{\GG}} (\wf{\GG}\sim\model{\GG}) \times
    \sum_{\model{A}} (\wf{A}\sim\model{A}) \times \\
    & &&
    \qquad
  (e_\GD : \model{\GD} = \model{\GG} \model{\ext} \model{A})
     \times
    \\
    & && \qquad
     (e_B : \model{B} = _{e_\GD \#} \model{\wk}\,\model{A}) \times
     % \\
     % & && \qquad
     (\model{t} = _{e_\GD,e_B \#} \model{\vz})
  \\
  &
   \relV{\vsw \wf{\GG} \wf{A} \wf{n} \wf{B}}{\model\GD}{\model{C}}{\model{t}}
  % \vsw \wf{\GG} \wf{A} \wf{n} \wf{B} \sim
  % \\
  % & \qquad
  %    (\model{\GD}\vdash \model{t}\in \model{C} )
   && :=
    \sum_{\model{\GG}} (\wf{\GG}\sim\model{\GG}) \times
    \sum_{\model{A}} (\wf{A}\sim\model{A}) \times
    \\
    & &&\qquad
    \sum_{\model{B}} (\wf{B}\sim\model{B}) \times
    \sum_{\model{n}} (\wf{n}\sim\model{n}) \times
    \\
    & &&
    \qquad
  (e_\GD : \model{\GD} = \model{\GG} \model{\ext} \model{B})
     \times
    \\
    & && \qquad
     (e_C : \model{C} = _{e_\GD \#} \model{\wk}\,\model{A}) \times
     \\
     & && \qquad
     (\model{t} = _{e_\GD,e_C \#} \model{\vs} \, \model{n})
  \\
  & \rlap{(2) Universe} \\
  & \Uw\, \wf{\GG} \wf{A} \sim \model{A} &&
   := \model{A} = \model{\U}
  \\
  & \Elw\, \wf{\GG} \wf{a} \sim \model{A}
  && :=
  \sum_{\model{a}} (\wf{a}\sim  \model{a}) \times
    (\model{A} = \model{\El}\,\model{a})
  \\
  & \rlap{(3) Inductive parameters} \\
  & \Piw\,\wf{\GG} \wf{a} \wf{B} \sim \model{C} &&
   :=
      \sum_{\model{a}} (\wf{a}\sim\model{a})
      \times
      \sum_{\model{B}} (\wf{B}\sim\model{B})
      \\
      &&& \qquad \times (\model{C}= \model{\Pi}\,\model{a}\,\model{B})
  \\
  &
  \relt{\appw\, \wf{\GG} \wf{a} \wf{B} \wf{t} \wf{u}}{\model{\GG}}{\model{C}}{\model{x}}  &&
  % & \appw \wf{\GG} \wf{a} \wf{B} \wf{t} \wf{u} \sim \\
  % & \qquad (\model{\GG}\vdash x\in \model{C})  &&
    :=
      \sum_{\model{a}} (\wf{a}\sim\model{a})
      \times
      \sum_{\model{B}} (\wf{B}\sim\model{B})
      \times
      \\
      & && \qquad
      \sum_{\model{t}} (\wf{t}\sim\model{t})
      \times
      \sum_{\model{u}} (\wf{u}\sim\model{u})
      \times
      \\
      & &&
     \qquad  (e_C : \model{C} = \model{B}\model{[0 := \model{u}]})
      \times
      \\
      & &&
      \qquad
      (\model{x} = _{e_C \#} \model{t} \model{\oldapp}\model{u})
    \\
  & \rlap{(4) Metatheoretic parameters} \\
  & \Pimw T\,A\,\wf{\GG}\wf{A} \sim \model{B} &&
    :=
      \sum_{\model{A}} ((t : T) \ra \wf{A}\sim\model{A}\, t)
      \times
      (\model{B} = \model{\Pim}\,T\,\model{A})
    \\
    & \relt{\appmw T\,A\,\wf{\GG}\wf{A} \wf{t} u}{\model{\GG}}{\model{B}}{\model{x}}
    % & \appmw T\,A\,\wf{\GG}\wf{A} \wf{t} u \sim
    % \\
    % & \qquad
    % (\model{\GG}\vdash x\in \model{B})
     &&
     :=
      \sum_{\model{A}} ((t : T) \ra \wf{A}\sim\model{A}\, t)
      \times
      \sum_{\model{t}} (\wf{t}\sim\model{t})
      \times
      \\ & &&
      \qquad
      (e_B : \model{B} = \model{\Pim}\,T\,\model{A})
      \times
      (\model{x} = _{e_B \#} \model{t}\model{\hat{\oldapp}}u)
\end{alignat*}
\end{definition}

% As discussed above, when writing the definition of the type components, we assume that the input semantic context is already
% related to the typing judgment of the syntactic context.
% The first version
% of the relation that we suggested at the beginning of the section
% would rather enforce them to be related.
% In the case of $\U$, this would lead
% to the definition
%   $  \Uw\wf{\GG} \sim \model{A} := (\wf{\GG}\sim\model{\GG}) \times (\model{A} = \model{\U})$,
%   instead of
%   the current definition
%   $  \Uw\wf{\GG} \sim \model{A} := (\model{A} = \model{\U})$.
%   Our choice makes the definitions more concise, and similarly
%  in the definition of the term components we assume that the input semantic
%  context and type are already related to their associated well-formedness judgments.
 % However, for some fields, we cannot avoid the first approach.
  % Unfortunately, we need sometimes to require some equalities that are actually
  % redundant with this external assumption.
  %, although we know that these equalities are
  % already satisfied by our assumption.
  % As we argued before, in the  of empty substitution $\epsilon$: we require the equality
  % $(e_C : \model{E} = \model{\boldsymbol{\cdot}})$, although
  % our claimed external assumption that $\model{E}$ is  related to the
  % canonical proof $\epsilonw$ of the typing judgment $\epsilon \vdash$ should imply
  % it.
% Let us comment the first variable case:
  % Another example is the first variable case, where we follow the first verbose
  % approach:
  % the relation gives a semantic context $\model\GG$ that must be related
  % to the syntactic $\GG$, and a semantic
  % type $\model{A}$ related to the syntactic $A$. The input semantic context is
  % then required to equal $\model{\GG}\model{\ext}\model{A}$.   As
  % $\blank \model{\ext}\blank$ is not guaranteed to be injective, these
  % relations are required to show that the relation is right unique.

\subsubsection{Right Uniqueness}\label{sec:right_uniqueness}

Next, we prove that this relation is right unique.  Then, we show that the
relation is stable under weakening and substitution.  The last step consists of
showing left-totality, i.e.\ giving a related semantic counterpart to any
well-typed context, type or term.  Everything is proved by induction on the typing
judgments.

\begin{lemma}[Right uniqueness]\label{lem:right_uniqueness}
The relation is right unique in the following sense:
  \begin{alignat*}{5}
    &
    \isp{\Sigma{\sim}}
    && : (\wf\GG : \GG \vdash ) && \ra
    \isaprop\, (\sum_{\model{\GG}} \wf{\GG} \sim \model{\GG})
    \\
    &
    \isp{\Sigma{\sim}}
    && : (\wf A : \GG \vdash A) && \ra
    \isaprop\, (\sum_{\model{A}} \wf{A} \sim \model{A})
    \\
    &
    \isp{\Sigma{\sim}}
    && : (\wf t : \GG \vdash t \in A) && \ra
    \isaprop\, (\sum_{\model{t}} \wf{t} \sim \model{t})
    \\
    &
    \isp{\Sigma{\sim}}
    && : (\wf x : \GG \vdash x \invar A) && \ra
    \isaprop\, (\sum_{\model{x}} \wf{x} \sim \model{x})
    \\
    &
    \isp{\Sigma{\sim}}
    && : (\wf \sigma : \GG \vdash \sigma \Rightarrow \GD) && \ra
    \isaprop\, (\sum_{\model{\sigma}} \wf{\sigma} \sim \model{\sigma})
  \end{alignat*}
\end{lemma}

\begin{remark}
  We mentioned that in order to avoid a recursive-recursive definition, we
  removed some hypotheses in the list of arguments of the relation. Such
  hypotheses are sometimes missed, for example in the case of the empty
  substitution or in the case of variables, requiring us to state additional
  equalities. Because of this, we need UIP to show that
  $\sum_{\model{\GG}}\GG\sim\model{\GG}$ and
  $\sum_{\model{A}}A\sim\model{A}$ are propositions.  One may think that the use
  of UIP could be avoided by using the alternative verbose definition that we
  suggested before, expecting that
  $\sum_{\model{\GG}}\sum_{\model{A}}A\sim\model{A}$, rather than
  $\sum_{\model{A}}A\sim\model{A}$, is a proposition.  However, this is not
  obvious. For example, we were not able to define
  $\Elw\,\wf{\GG}\,\wf{a}\sim \model{A}$ in this fashion. In related work,
  Hugunin investigated constructing IITs without
  UIP \cite{jasper} in cubical type theory, and demonstrated
  that well-formedness predicates used in syntactic algebras can subtly break
  in that setting. Also, while Hugunin does not use UIP, he only shows the simple version
  version of dependent elimination for the constructed IITs. Hence, the
  question whether IITs are reducible to inductive types in a UIP-free setting
  remains open.
\end{remark}

\subsubsection{Stability under Weakening and Substitution}

%% in this fashion so that
%%   UIP can be avoided to prove this statement.


  % \todo[inline]{András: Hugunin's paper has an example (which is
  %    likely generalizable) that a notion of redundancy in
  %    well-formedness relations implies that UIP is required.}
  % Let us argue that it is necessary to show s
  Stability of the relation under
  weakening must be proved before stability under substitution.
  Indeed, in the proof of stability under substitution, the $\Pi$ case
  requires to show that $\Pi \,(A[\sigma]) \,(B[\keep\,\sigma])$ is related to
  $\model{\Pi}\,(\model{A}\model{[\sigma]})\,
  (\model{B}\model{[\model{\keep}\,\sigma]})$.
  We would like to apply the induction hypothesis, so we need to show that
  $\keep\,\sigma=\wkO\,\sigma\consu \varu\,\mathsf{0}$ is related to
  $\model{\keep}\,\model{\sigma}$, knowing that $\sigma$ is
  related to $\model{\sigma}$.
  As $\keep\,\sigma=\wkO\,\sigma\consu \varu\, \mathsf{0}$, we are left with showing that
  $\wkO\,\sigma=\sigma\circ\wk$ (where $\wk=\wkO\,\id$)
  relates to its semantic counterpart.

%   {-

% Suppose that Γ ^^ Δ ⊢ and Γ ⊢ E
% The following function computes both Γ ▶ E ^^ wk_E Δ and a substitution
% from this context to Γ ^^ Δ.
% I don't see how to avoid constructing these two components simultaneously

% -}
% ΣwkTel⇒ᵐ :
%   ∀ {Γ}{Γw :  Γ ⊢}(Γm : ∃ (Con~ Γw) )
%     (Em : M.Ty (₁ Γm))
%         {Δ }{Δw : Γ ^^ Δ ⊢}(Δm : ∃ (Con~ Δw)) →
        % ∃ λ T → M.Sub T (₁ Δm)


  To achieve that, we show that $\wkO$ preserves the relation, for types and terms.
  This requires to generalise a bit and show that $\wk_n$ preserves the relation,
  as $\wk_0\,(\Pi\,A\,B)=\Pi\,(\wk_0\,A)\,(\wk_1\,B)$.
  But remember that $\wk_n$ performs a weakening in the middle of a context, so
  we first define the semantic counterpart of this:
\begin{alignat*}{5}
  & \model{\Sigma\wkO{\Rightarrow}}  && :
   % & && \qquad
  (\wf{\GG} : \GG \vdash) \ra
  (\wf\GG \sim \model{\GG}) \ra
  \\
  & && \qquad
  (\wf{\GD} : \GG\merge\GD \vdash) \ra
  (\wf\GD \sim \model{\GD}) \ra
  \\ &&& \qquad
  (\model{A} : \model\Ty\model\GG)\ra
  (\model{\GD'} : \model{\Con}) \times (\model{\Sub}\model{\GD'}{\model{\GD}})
\end{alignat*}
Here, $\model{\GD'}$ should be thought of as the context $\model\GD$ where
the weakening has happened in the middle of the context, by inserting the type
$\model{A}$ after the prefix $\model{\GG}$. Indeed, we expect that
$\model{\GG}$ is a prefix of $\model{\GD}$, as $\model{\GG}$ relates to
$\GG$ and $\model{\GD}$ to $\GG\merge\GD$.
% $\wf{\GG}\sim\model\GG$
% and $\wf\GD\sim\model\GD$, and $\GG$ is a prefix of $\GG\merge\GD$.
The substitution from the weakened context to the original one must
be computed at the same time otherwise the induction hypothesis is not strong enough.
Then, we separate the two components under the same (implicit) hypotheses:
\begin{alignat*}{5}
  & \model{\wkO}\,\model{A}\,\model\GD  && :
  % (\model{A} : \model\Ty\model\GG)\ra
  % (\wf{\GG} : \GG \vdash) \ra
  % (\wf{\GD} : \GG\merge\GD \vdash) \ra
  % \\
  % & && \qquad
  % (\wf\GG \sim \model{\GG}) \ra
  % (\wf\GD \sim \model{\GD}) \ra
  % \\ &&& \qquad
   \model{\Con}
   \\
  & \model{\wk{\Rightarrow}}\,\model{A}\,\model\GD  && :
  % (\model{A} : \model\Ty\model\GG)\ra
  % (\wf{\GG} : \GG \vdash) \ra
  % (\wf{\GD} : \GG\merge\GD \vdash) \ra
  % \\
  % & && \qquad
  % (\wf\GG \sim \model{\GG}) \ra
  % (\wf\GD \sim \model{\GD}) \ra
  % \\ &&& \qquad
   \model{\Sub}(\model{\wkO}\model{A}\,\model\GD)\model\GD
\end{alignat*}
Note that if recursion-recursion is available in the metatheory, $\model\wkO$
and $\wk\model{\Rightarrow}$ can be defined directly without introducing this
intermediate $\model{\Sigma\wkO\Rightarrow}$.

\begin{lemma}[Weakening preserves typing]
The following statements are all under the
hypotheses
  $(\wf{\GG} : \GG \vdash)$,
  $(\wf\GG \sim \model{\GG})$,
  $(\wf{\GD} : \GG\merge\GD \vdash)$,
  $(\wf\GD \sim \model{\GD})$,
  $(\wf{A} : \GG \vdash A)$,
  and
  $(\wf{A} \sim \model{A})$.
  % , except the last one about weakening substitutions,
  % which do not require that $\model\GD$ is related to any well-formed context.
\begin{alignat*}{5}
  & \wkO{\sim}  &&
   :
  % (\wf{\GG} : \GG \vdash) \ra
  % (\wf\GG \sim \model{\GG}) \ra
  % \\
  %  & && \qquad
  % (\wf{\GD} : \GG\merge\GD \vdash) \ra
  % (\wf\GD \sim \model{\GD}) \ra
  % \\
  % & && \qquad
  % (\wf{A} : \GG \vdash A) \ra
  % (\wf{A} \sim \model{A}) \ra
  % \\
  % & && \qquad
  \wf{\wkO}\,\wf{A}\,\wf{\GD}\sim\model{\wkO}\model{A}\model{\GD}
  \\
  % wk
  & \wk{\sim} && :
  % (\wf{\GG} : \GG \vdash) \ra
  % (\wf\GG \sim \model{\GG}) \ra
  % \\
  %  & && \qquad
  % (\wf{\GD} : \GG\merge\GD \vdash) \ra
  % (\wf\GD \sim \model{\GD}) \ra
  % \\
  % & && \qquad
  % (\wf{A} : \GG \vdash A) \ra
  % (\wf{A} \sim \model{A}) \ra
  % \\
  % &&& \qquad
  (\wf{T} : \GG\merge\GD \vdash T) \ra
  (\wf{T} \sim \model{T}) \ra
  % \\ &&& \qquad
  \wf{\wk}\,\wf{A}\,\wf{T}\sim\model{T}\model{[\model{\wkO{\Rightarrow}}\model{A}\model{\GD}]}
  \\
    % wk
  & \wk{\sim} && :
  % (\wf{\GG} : \GG \vdash) \ra
  % (\wf\GG \sim \model{\GG}) \ra
  % \\
  %  & && \qquad
  % (\wf{\GD} : \GG\merge\GD \vdash) \ra
  % (\wf\GD \sim \model{\GD}) \ra
  % \\
  % & && \qquad
  % (\wf{A} : \GG \vdash A) \ra
  % (\wf{A} \sim \model{A}) \ra
  % \\
  % &&& \qquad
  (\wf{t} : \GG\merge\GD \vdash t\in T) \ra
  (\wf{t} \sim \model{t}) \ra
  % \\ &&& \qquad
  \wf{\wk}\,\wf{A}\,\wf{t}\sim\model{t}\model{[\model{\wkO{\Rightarrow}}\model{A}\model{\GD}]}
  \\
    % wk
  & \wk{\sim} && :
  % (\wf{\GG} : \GG \vdash) \ra
  % (\wf\GG \sim \model{\GG}) \ra
  % \\
  %  & && \qquad
  % (\wf{\GD} : \GG\merge\GD \vdash) \ra
  % (\wf\GD \sim \model{\GD}) \ra
  % \\
  % & && \qquad
  % (\wf{A} : \GG \vdash A) \ra
  % (\wf{A} \sim \model{A}) \ra
  % \\
  % &&& \qquad
  (\wf{x} : \GG\merge\GD \vdash t\invar T) \ra
  (\wf{x} \sim \model{x}) \ra
  % \\ &&& \qquad
  \wf{\wk}\,\wf{A}\,\wf{x}\sim\model{x}\model{[\model{\wkO{\Rightarrow}}\model{A}\model{\GD}]}
  % \\ &&& \qquad
  % \wf{\wk}\,\wf{A}\,\wf{x}\sim\model{x}\model{[\model{\wkO{\Rightarrow}}\model{A}\model{\GD}]}
\end{alignat*}
\end{lemma}
\begin{proof}
By mutual induction on the typing judgments.
\end{proof}

\begin{lemma}[Weakening of substitution preserves $\blank\sim\blank$]
\begin{alignat*}{5}
    % wk
  & \wkO{\sim} && :
  (\wf{\GG} : \GG \vdash) \ra
  (\wf\GG \sim \model{\GG}) \ra
  % \\
  %  & && \qquad
  % (\wf{\GD} : \GG\merge\GD \vdash) \ra
  % (\wf\GD \sim \model{\GD}) \ra
  % \\
  % & && \qquad
  (\wf{A} : \GG \vdash A) \ra
  (\wf{A} \sim \model{A}) \ra
  \\
  &&& \qquad
  (\wf{\sigma} : \GG\vdash \sigma \Rightarrow \GD) \ra
  (\wf{\sigma} \sim \model{\sigma}) \ra
  % \\
  % &&& \qquad
  (\wf{\wkO}\wf{A}\wf\sigma \sim \model{\sigma}\model{\circ}\model{\wk})
  \end{alignat*}
\end{lemma}
\begin{proof}
By induction on the typing judgments.
\end{proof}



%   But to give a precise meaning to the statement that $\wk_n$ (which weakens at
%   the middle of context) preserve the
%   relation, we define (inductively) the notion of semantic telescopes.
%   First, we define the notion of being a prefix:
% \begin{alignat*}{5}
%   & \blank\leq\blank  && : \model\Con\ra \model\Con\ra\Set \\
%   & {\leq}\boldsymbol{\cdot}  && : \model{\GG} \leq \model{\GG} \\
%   & \blank{\leq}{\ext}\blank  && : \model{\GG} \leq \model{\GD} \ra (A :
%   \model{\Ty}\GD) \ra \model{\GG}\leq\model{\GD}\model{\ext}\model{A}
% \end{alignat*}
% Now, a telescope on a semantic context $\model{\GG}$ is a semantic context
% $\model{\GD}$ such that $\model{\GG}\leq \model{\GD}$.

% \begin{alignat*}{5}
%   & \Tel\,\model{\GG}  && := (\model{\GD} : \model{\Con})\times (\model{\GG}\leq \model{\GD})
% \end{alignat*}
% Similarly to the untyped case, we define the merging of a context and a telescope by recursion on the telescope:
% \begin{alignat*}{5}
%   & \blank\model{\merge}\blank  && := (\model{\GG} : \model{\Con}) \ra
%   (\model{\GD} : \Tel\,\model\GG) \ra \model{\Con} \\
%   & \model\GG \merge (\model\GG,{\leq}\boldsymbol{\cdot}) && :=  \model\GG \\
%   & \model\GG \merge (\model\GD\model{\ext}\model{A}, \GD_{\leq} {\leq}{\ext} \model{A}) && :=  (\model\GG \model\merge \model\GD)\model\ext \model{A}\\
% \end{alignat*}
% We then define a relevant relation between syntactic telescopes and semantic telescopes.
% Untyped syntactic telescopes are modeled by untyped contexts, because they are
% list of types.
% A syntactic telescope $\GD$ is then well formed in a context $\GG$ if
% $\GG\merge\GD$ is well formed.
% The relation is defined by recursion on the untyped syntactic telescope:
% \begin{alignat*}{5}
%   & \blank\sim\blank  && := ( \GG \merge \GD \vdash) \ra (\model\GG\leq\model\GD)
%   \ra \Set \\
%   & (\wf\GG : \GG \merge \emptyu \vdash)\sim\model\GD  && :=
%   \model\GD =  {\leq}\boldsymbol{\cdot}\\
%   & (\wf\GD \extw \wf{A} : \GG \merge (\GD \extu A) \vdash)\sim\model{E}  && :=
%   \sum_{\model\GD} (\wf\GD\sim\model\GD)
%   \times
%   \sum_{\model A} (\wf{A}\sim\model{A}) \times
%   \\
%   & && \qquad
%   \model{E} = \model\GD {\leq}{\ext} \model{A}
% \end{alignat*}

Next, we want to prove that given any well-typed substitution $\sigma
: \Sub\,\GG\,\GD$ and semantic contexts $\model{\GG}$ and
$\model{\GD}$, related to $\GG$ and $\GD$, respectively, there is a
semantic substitution related to $\sigma$.  In the extension case
$\GG\vdash \sigma \consu\,t\Rightarrow \GD\,\extu\,A$, the induction
hypothesis provides $\model{\sigma}$, $\model{\GD}$, $\model{A}$ related to
their syntactic counterpart. However, the premises of the induction hypothesis
for getting a relevant $\model{t}$ require showing that the type
$\model{A}\model{[\model{\sigma}]}$ is related to the syntactic type
$A[\sigma]$.
\begin{lemma}[Preservation of the relation by substitution for variables]
\begin{alignat*}{5}
    % []V~
  & []{\sim} && :
  (\wf{\sigma} : \GG \vdash \sigma \Rightarrow \GD) \ra
  (\wf\sigma \sim \model{\sigma}) \ra
  (\wf{x} : \GD \vdash x \invar A) \ra
  (\wf{x} \sim \model{x}) \ra
  \\ & && \qquad
  % \\
  % & && \qquad
   \wf{[]}\wf{x}\wf{\sigma} \sim \model{x}\model{[\model{\sigma}]}
\end{alignat*}
\end{lemma}
\begin{proof}
  Induction on typing.
\end{proof}

\begin{lemma}[Preservation of the relation by substitution for types and terms]
We assume
  $(\wf{\sigma} : \GG \vdash \sigma \Rightarrow \GD)$,
  $(\wf\sigma \sim \model{\sigma})$,
  $(\wf{\GG} : \GG \vdash )$,
  $(\wf{\GG} \sim \model{\GG})$,
  % \\
  % &&&\qquad
    $(\wf{\GD} : \GD \vdash )$,
    and
  $(\wf{\GD} \sim \model{\GD})$:
\begin{alignat*}{5}
     & []{\sim} && :
    (\wf{A} : \GD \vdash A) \ra
  (\wf{A} \sim \model{A}) \ra
  % \\
  % & && \qquad
   \wf{[]}\wf{\GG}\wf{A}\wf{\sigma} \sim \model{A}\model{[\model{\sigma}]}
   \\
     & []{\sim} && :
    (\wf{t} : \GD \vdash t \in A ) \ra
  (\wf{t} \sim \model{t}) \ra
  % \\
  % & && \qquad
   \wf{[]}\wf{\GG}\wf{t}\wf{\sigma} \sim \model{t}\model{[\model{\sigma}]}
 \end{alignat*}
\end{lemma}
\begin{proof}
  Mutual induction on typing.
\end{proof}
\begin{lemma}[The relation is preserved by composition and identity]
  We have the same hypotheses as in the previous lemma.
  \begin{alignat*}{5}
     & {\circ}{\sim} && :
    (\wf{E} : E \vdash ) \ra
  (\wf{E} \sim \model{E}) \ra
  % \\
  % &&&  \qquad
    (\wf{\delta} : \GD \vdash \delta \Rightarrow E) \ra
  (\wf{\delta} \sim \model{\delta}) \ra
  \\
  & && \qquad
   \wf{{\circ}}\,\wf{\GG}\,\wf{\delta}\,\wf{\sigma} \sim \model{\delta}\mathbin{\model{\circ}}\model{\sigma} \\
     & {\id}{\sim} && :
    (\wf{\GG} : \GG \vdash ) \ra
  (\wf{\GG} \sim \model{\GG}) \ra
   \wf{{\id}}\,\wf{\GG} \sim {\id}_{\model{\GG}}
 \end{alignat*}
 \end{lemma}
% $\model{t}\model\oldapp\model{u}$, but it has type
% $\model{B}\model{[0 := \model{u}]}$
% instead of type $\model{T}$. Fortunately, we know by hypothesis that $\model{T}$
% relates to $T=B[0:=u]$ so, by uniqueness of the related semantic counterpart,
% we can deduce that $\model{T}=\m$
% Thus, we need to show that $\model{T}=\model{B}\model{[0 := \model{u}]}$ if we
% know that this last type is related to $B[0 := u]$.

\subsubsection{Left-Totality and the Recursor}

Before defining the recursor $\ll\blank\rr$, we show left totality of
the relation: that is, the image of a syntactic context is a unique
semantic context which is related to it, and similarly for types and
terms.
% We construct it as the semantic
% Induction on the typing judgments shows that any QIIT morphism from the
% syntactic model $S$  to a semantic model $M$ sends well-typed syntax on a related
% semantic counter-part.
\begin{lemma}[Left totality of $\blank\sim\blank$]
\begin{alignat*}{5}
     & \Sigma\Con{\sim} && :
    (\wf{\GG} : \GG \vdash ) \ra
    \sum_{\model{\GG}} \wf{\GG} \sim \model{\GG}
    \\
     & \Sigma\Ty{\sim} && :
    (\wf{\GG} : \GG \vdash ) \ra
    (\wf{\GG}\sim \model\GG) \ra
    (\wf{A} : \GG \vdash A ) \ra
    ({\model{A}:\model{\Ty}\model\GG})\times ( \wf{A} \sim \model{A})
    \\
     & \Sigma\Tm{\sim} && :
    (\wf{\GG} : \GG \vdash ) \ra
    (\wf{\GG}\sim \model\GG) \ra
    (\wf{A} : \GG \vdash A ) \ra
    ( \wf{A} \sim \model{A}) \ra
    \\ & && \qquad
    (\wf{t} : \GG \vdash t \in A ) \ra
    ({\model{t}:\model{\Tm}\model\GG}\model{A})\times ( \wf{t} \sim \model{t})
    \\
     & \Sigma\Var{\sim} && :
    (\wf{\GG} : \GG \vdash ) \ra
    (\wf{\GG}\sim \model\GG) \ra
    (\wf{A} : \GG \vdash A ) \ra
    ( \wf{A} \sim \model{A}) \ra
    \\ & && \qquad
    (\wf{x} : \GG \vdash x \invar A ) \ra
    ({\model{x}:\model{\Tm}\model\GG}\model{A})\times ( \wf{x} \sim \model{x})
    \\
     & \Sigma\Sub{\sim} && :
    (\wf{\GG} : \GG \vdash ) \ra
    (\wf{\GG}\sim \model\GG) \ra
    (\wf{\GD} : \GD \vdash  ) \ra
    ( \wf{\GD} \sim \model{\GD}) \ra
    \\ & && \qquad
    (\wf{\sigma} : \GG \vdash \sigma \Rightarrow \GD ) \ra
    ({\model{\sigma}:\model{\Sub}\model\GG}\model{\GD})\times ( \wf{\sigma} \sim \model{\sigma})
  \end{alignat*}
\end{lemma}
\begin{proof}
  By induction on well-formedness judgments. The right uniqueness of
  the relation is used in this induction.
\end{proof}

\begin{lemma}[Existence of the recursor]\label{lem:rec}
  For any $M:\SignAlg$ there is a $\ll\blank\rr : \SignMor\,\I\,M$
  where $\I$ is given in \Cref{def:syntax}.
\end{lemma}
\begin{proof}
  Using the first projections in the construction of the left-totality
  construction and right uniqueness.
\end{proof}

\subsection{Uniqueness}

It remains to show that the morphism constructed in \Cref{lem:rec} is
unique. We exploit right uniqueness of the relation: it is enough to
show that any such morphism maps a syntactic context to a related
semantic context, and similarly for types and terms.

\begin{lemma}
  We assume an arbitrary signature morphism $f$ from $\I$ to $M$. This
  induces the following maps:
\begin{alignat*}{5}
  &
  \mor{\Con}
  && :
   (\GG \vdash) \ra \model\Con
   \\
  &
  \mor{\Ty}
  && :
   (\wf\GG:\GG \vdash) \ra (\GG\vdash A)\ra\model\Ty\,(\mor\Con\wf\GG)
   \\
  &
  \mor{\Tm}
  && :
  (\wf\GG:\GG \vdash) \ra (\wf{A}:\GG\vdash A)\ra
  (\GG\vdash t \in A)\ra\model\Tm\,(\mor\Con\wf\GG)\,
  (\mor\Ty\wf\GG\,\wf{A})
   \\
  &
  \mor{\Var}
  && :
  (\wf\GG:\GG \vdash) \ra (\wf{A}:\GG\vdash A)\ra
  (\GG\vdash x \invar A)\ra\model\Tm\,(\mor\Con\wf\GG)\,
  (\mor\Ty\wf\GG\,\wf{A})
   \\
  &
  \mor{\Sub}
  && :
  (\wf\GG:\GG \vdash) \ra
  (\wf\GD:\GD \vdash) \ra
  (\GG\vdash \sigma \Rightarrow \GD)\ra\model\Sub\,(\mor\Con\wf\GG)\,
  (\mor\Con\wf\GD)
\end{alignat*}
The images of the above maps are related by $\blank\sim\blank$:
\begin{alignat*}{5}
  &
  {\sim}\mor{\Con}
  && :
  (\wf\GG : \GG \vdash) \ra \wf\GG\sim \mor\Con\,\wf\GG
  \\
  &
  {\sim}\mor{\Ty}
  && :
  (\wf\GG : \GG \vdash) \ra
  (\wf{A} : \GG \vdash A) \ra
  \wf\GG\sim \mor\Ty\,\wf\GG\,\wf{A}
  \\
  &
  {\sim}\mor{\Tm}
  && :
  (\wf\GG : \GG \vdash) \ra
  (\wf{A} : \GG \vdash A) \ra
  (\wf{t} : \GG \vdash t \in A) \ra
  \wf\GG\sim \mor\Tm\,\wf\GG\,\wf{A}\,\wf{t}
  \\
  &
  {\sim}\mor{\Var}
  && :
  (\wf\GG : \GG \vdash) \ra
  (\wf{A} : \GG \vdash A) \ra
  (\wf{x} : \GG \vdash x \invar A) \ra
  \wf\GG\sim \mor\Var\,\wf\GG\,\wf{A}\,\wf{x}
  \\
  &
  {\sim}\mor{\Sub}
  && :
  (\wf\GG : \GG \vdash) \ra
  (\wf{\GD} : \GD \vdash) \ra
  (\wf{\sigma} : \GG \vdash \sigma \Rightarrow \GD) \ra
  \wf\GG\sim \mor\Sub\,\wf\GG\,\wf{\GD}\,\wf{\sigma}
\end{alignat*}
\end{lemma}
\begin{proof}
  By induction on typing relations.
\end{proof}

\begin{corollary}[Uniqueness of the recursor]\label{lem:uniq}
  By right uniqueness of $\blank\sim\blank$, there is only one
  morphism $\SignMor\,\I\,M$ for any $M$.
\end{corollary}

\begin{theorem}\label{thm:WToToS}
  If a model of ETT supports indexed W-types, it supports the theory
  of IIT signatures.
\end{theorem}
\begin{proof}
  We define the syntax $\I$ by \Cref{def:syntax} which only used
  indexed W-types, the recursor by \Cref{lem:rec} and we prove its
  uniqueness property by \Cref{lem:uniq}.
\end{proof}

\begin{corollary}\label{thm:WToIITs}
  If a model of ETT supports indexed W-types, it supports all IITs.
\end{corollary}
\begin{proof}
  Combining \Cref{thm:WToToS} and \Cref{thm:ToSToIITs}.
\end{proof}

% \begin{description}
%   \item[untyped syntax and well typed judgments as an algebra]
%   \begin{enumerate}
%   \item define untyped syntax as an inductive datatype
%   \item define operations on the syntax, such as substitution, by recursion
%   \item define well-typed judgments as an inductive datatype indexed over the untyped syntax
%   \item show the dependant pair of untyped syntax with well-typed judgments
%     define an algebra
%   \end{enumerate}
%   \item[specification of the initial morphism as a functional relation]
%   \begin{enumerate}
%   \item given an algebra, define the functional relation enjoyed by the recursor
%     from the syntax to the algebra by recursion over the well-typed judgment
%   \item show right-uniqueness of the relation
%   \item show left-totality of the relation
%   \end{enumerate}
%   \item[existence and uniqueness of the morphism from the syntax to a model]
%     \begin{enumerate}
%   \item show uniqueness of such a morphism
%   \item extract an algebra morphism from the relation
%     \end{enumerate}
% \end{description}
